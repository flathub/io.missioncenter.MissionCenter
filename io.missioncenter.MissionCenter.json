{
  "app-id": "io.missioncenter.MissionCenter",
  "runtime": "org.gnome.Platform",
  "runtime-version": "44",
  "sdk": "org.gnome.Sdk",
  "command": "missioncenter",
  "build-options": {
    "no-debuginfo": true
  },
  "finish-args": [
    "--share=network",
    "--share=ipc",
    "--socket=fallback-x11",
    "--device=all",
    "--socket=wayland",
    "--talk-name=org.freedesktop.Flatpak",
    "--talk-name=org.gnome.Settings",
    "--system-talk-name=org.freedesktop.systemd1",
    "--system-talk-name=org.freedesktop.NetworkManager",
    "--filesystem=xdg-data/flatpak/exports/share:ro",
    "--filesystem=/var/lib/flatpak/exports/share:ro",
    "--filesystem=xdg-data/flatpak/app:ro",
    "--filesystem=/var/lib/flatpak/app:ro",
    "--env=XDG_DATA_DIRS=/app/share:/usr/share:/usr/share/runtime/share:/run/host/user-share:/run/host/share:/var/lib/flatpak/exports/share:~/.local/share/flatpak/exports/share"
  ],
  "cleanup": [
    "/sbin",
    "/etc",
    "/sbin",
    "/include",
    "/lib/pkgconfig",
    "/lib/python*",
    "/man",
    "/share/doc",
    "/share/gtk-doc",
    "/share/man",
    "/share/pkgconfig",
    "*.la",
    "*.a"
  ],
  "modules": [
    {
      "name": "build-tools",
      "buildsystem": "simple",
      "build-commands": [
        "echo 'Extract the cross-toolchain manually, it fails otherwise.'",
        "mkdir cross-rootfs && cd cross-rootfs && tar xf ../ubuntu-14.04-*.tar.zst && rm ../ubuntu-14.04-*.tar.zst",
        "mv * /app/"
      ],
      "sources": [
        {
          "type": "archive",
          "url": "https://missioncenter.io/build-tools/rust-toolchain-1.71.0-x86_64.tar.zst",
          "dest": "rust-toolchain",
          "sha256": "b5afacde977aa18a59385628dd8ec2bf6f18738b27e009df0c750efc4d5578ee",
          "only-arches": [
            "x86_64"
          ]
        },
        {
          "type": "file",
          "url": "https://missioncenter.io/build-tools/ubuntu-14.04-x86_64.tar.zst",
          "sha256": "92b613a9a91ac5add802a2803af6db6d03b4cd073c7753896ea3d3020fad1a16",
          "only-arches": [
            "x86_64"
          ]
        },
        {
          "type": "archive",
          "url": "https://missioncenter.io/build-tools/rust-toolchain-1.71.0-aarch64.tar.zst",
          "dest": "rust-toolchain",
          "sha256": "5bac97fe7f6c16529e952ced5f0e99b614fa246445a092473ad31ba59929b34b",
          "only-arches": [
            "aarch64"
          ]
        },
        {
          "type": "file",
          "url": "https://missioncenter.io/build-tools/ubuntu-14.04-aarch64.tar.zst",
          "sha256": "37b2f6aaf45b7d76d18595f1505a776d9b47201a55b1d0c6e2f0cc795aaa8df5",
          "only-arches": [
            "aarch64"
          ]
        }
      ],
      "cleanup": [
        "*"
      ]
    },
    {
      "name": "musl-libc",
      "buildsystem": "autotools",
      "config-opts": [
        "--prefix=/app/musl-libc"
      ],
      "post-install": [
        "tar xf libgcc*.xbps && mv usr/lib/libgcc_s.so.1 /app/musl-libc/lib/ && ln -s libgcc_s.so.1 /app/musl-libc/lib/libgcc_s.so && rm -rf usr libgcc*.xbps"
      ],
      "sources": [
        {
          "type": "archive",
          "url": "https://musl.libc.org/releases/musl-1.2.3.tar.gz",
          "sha256": "7d5b0b6062521e4627e099e4c9dc8248d32a30285e959b7eecaa780cf8cfd4a4"
        },
        {
          "type": "file",
          "url": "https://alpha.de.repo.voidlinux.org/current/musl/libgcc-12.2.0_2.x86_64-musl.xbps",
          "sha256": "33707d0360211cf097e5862529dad59dd16f33f76eb58d47f26ffd18239df990",
          "only-arches": [
            "x86_64"
          ]
        },
        {
          "type": "file",
          "url": "https://alpha.de.repo.voidlinux.org/current/aarch64/libgcc-12.2.0_2.aarch64-musl.xbps",
          "sha256": "7d1855eba3d1a947159da614a275c52115c95c9acbb57022eb2b0653c65c2fd9",
          "only-arches": [
            "aarch64"
          ]
        }
      ],
      "cleanup": [
        "*"
      ]
    },
    {
      "name": "missioncenter-proxy",
      "buildsystem": "simple",
      "build-options": {
        "append-path": "/app/rust-toolchain/bin",
        "env": {
          "RUST_BACKTRACE": "full",
          "RUSTUP_HOME": "/app/rust-toolchain",
          "CARGO_HOME": "/build-dir/src/proxy/cargo"
        }
      },
      "build-commands": [
        "cd src/proxy && cargo build --offline --release --target $(arch)-unknown-linux-musl",
        "install -v -p -m 755 src/proxy/target/$(arch)-unknown-linux-musl/release/proxy /app/bin/missioncenter-proxy-musl",
        "rm -rf src/proxy/target",
        "",
        "/app/bin/proot -b /app/rust-toolchain:/app/rust-toolchain -b $PWD:/build-dir -R /app/cross-rootfs /bin/sh -c 'cd /build-dir/src/proxy && /app/rust-toolchain/bin/cargo build --offline --release'",
        "install -v -p -m 755 src/proxy/target/release/proxy /app/bin/missioncenter-proxy-glibc"
      ],
      "sources": [
        {
          "type": "git",
          "url": "https://gitlab.com/mission-center-devs/mission-center.git",
          "commit": "883c9eb2e8c5fbbec2de2fd5d5a643c562ef3b07"
        },
        {
          "type": "inline",
          "contents": "[source.vendored-sources]\ndirectory = \"../../cargo/vendor\"\n\n[source.crates-io]\nreplace-with = \"vendored-sources\"\n\n[target.x86_64-unknown-linux-musl]\nlinker = \"/app/musl-libc/bin/musl-gcc\"\nrustflags = [ '-C', 'target-feature=-crt-static' ]\n\n[target.aarch64-unknown-linux-musl]\nlinker = \"/app/musl-libc/bin/musl-gcc\"\nrustflags = [ '-C', 'target-feature=-crt-static' ]\n",
          "dest": "src/proxy/.cargo",
          "dest-filename": "config.toml"
        },
        "cargo-sources-proxy.json"
      ],
      "modules": [
        {
          "name": "proot",
          "buildsystem": "simple",
          "build-commands": [
            "make -C src loader.elf build.h",
            "make -C src proot",
            "install -v -p -m 755 src/proot /app/bin/proot"
          ],
          "sources": [
            {
              "type": "git",
              "url": "https://github.com/proot-me/proot.git",
              "tag": "v5.4.0",
              "commit": "bd5a5f63d72f8210d8cee76195eb9f0749e5bd70"
            }
          ],
          "modules": [
            {
              "name": "libarchive",
              "buildsystem": "autotools",
              "config-opts": [
                "--disable-bsdcat",
                "--disable-bsdcpio",
                "--disable-bsdtar"
              ],
              "sources": [
                {
                  "type": "archive",
                  "url": "https://libarchive.org/downloads/libarchive-3.6.2.tar.xz",
                  "sha256": "9e2c1b80d5fbe59b61308fdfab6c79b5021d7ff4ff2489fb12daf0a96a83551d"
                }
              ],
              "cleanup": [
                "*"
              ]
            },
            {
              "name": "libtalloc",
              "buildsystem": "autotools",
              "sources": [
                {
                  "type": "archive",
                  "url": "https://www.samba.org/ftp/talloc/talloc-2.4.1.tar.gz",
                  "sha256": "410a547f08557007be0e88194f218868358edc0ab98c98ba8c167930db3d33f9"
                }
              ],
              "cleanup": [
                "*"
              ]
            }
          ],
          "cleanup": [
            "*"
          ]
        }
      ]
    },
    {
      "name": "missioncenter",
      "buildsystem": "meson",
      "build-options": {
        "append-path": "/app/rust-toolchain/bin",
        "env": {
          "RUST_BACKTRACE": "full",
          "RUSTUP_HOME": "/app/rust-toolchain/"
        }
      },
      "config-opts": [
        "-Dbuildtype=release",
        "-Dflatpak=true",
        "-Dcargo_env='CARGO_HOME=/run/build/missioncenter/cargo'"
      ],
      "sources": [
        {
          "type": "git",
          "url": "https://gitlab.com/mission-center-devs/mission-center.git",
          "commit": "883c9eb2e8c5fbbec2de2fd5d5a643c562ef3b07"
        },
        {
          "type": "archive",
          "url": "https://github.com/Syllo/nvtop/archive/9a8458b541a195a0c5cadafb66e240962c852b39.tar.gz",
          "sha256": "290542e3c2203613e18faaa769dcc5479b170c39acbe71c976a7e86ff03ea1a7",
          "dest": "subprojects/nvtop-9a8458b541a195a0c5cadafb66e240962c852b39"
        },
        {
          "type": "shell",
          "commands": [
            "cd subprojects/nvtop-* && find ../packagefiles -type f -name 'nvtop-*' -exec sh -c 'patch -p1 < {}' \\;"
          ]
        },
        "cargo-sources.json"
      ],
      "modules": [
        {
          "name": "eudev",
          "buildsystem": "autotools",
          "cleanup": [
            "/bin",
            "/sbin",
            "/etc",
            "/lib/udev"
          ],
          "sources": [
            {
              "type": "git",
              "url": "https://github.com/eudev-project/eudev.git",
              "commit": "39979ddf46e75d1b75bf381e1c73914c226c4302"
            }
          ]
        },
        {
          "name": "blueprint-compiler",
          "buildsystem": "meson",
          "sources": [
            {
              "type": "git",
              "url": "https://gitlab.gnome.org/jwestman/blueprint-compiler",
              "commit": "f526cfa4d92a02be1eeb539076e22b06bc9ab887"
            }
          ],
          "cleanup": [
            "*"
          ]
        },
        {
          "name": "static-binaries",
          "buildsystem": "simple",
          "build-commands": [
            "/bin/true"
          ],
          "modules": [
            {
              "name": "dmidecode",
              "buildsystem": "simple",
              "build-commands": [
                "make CC=/app/musl-libc/bin/musl-gcc CFLAGS=\"-static -I/app/musl-libc/include\" LDFLAGS=\"-static -L/app/musl-libc/lib\" install-bin prefix=/app",
                "install -v -p -m 755 /app/sbin/dmidecode /app/bin/dmidecode"
              ],
              "sources": [
                {
                  "type": "archive",
                  "url": "https://git.savannah.nongnu.org/cgit/dmidecode.git/snapshot/dmidecode-3-5.tar.gz",
                  "sha256": "8b1465a1afa71f9ffb0206ba5ffc435c46c0281d089552578f600879728a1b23"
                }
              ]
            }
          ]
        }
      ]
    }
  ]
}
